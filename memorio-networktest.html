<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="360" >
    <title>memor.io</title>
    
    <script src="https://unpkg.com/p5@1.4.0/lib/p5.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
    	body {
    		margin:  0;
    	}
    </style>
	</head>

	<body>
		<script>



const decoder = new TextDecoder("utf-8");

const id = Math.floor( Math.random() * Math.pow( 255, 2 ) ).toString(16); // generate random base-16 code as id
const char = Math.ceil( Math.random() * 255 );
const color = Math.floor( Math.random() * Math.pow( 255, 3 ) ).toString(16);

const memory = {
  	id: id,
  	char: char,
  	color: color,
  	x: 100,
  	y: 100
  }

const idaddr = '/memor/' + id;
const clientId = "memor.io-" + id;

// MQTT --------------------
const server = "wss://datt3700:datt3700experiments@datt3700.cloud.shiftr.io";
const client = mqtt.connect(server, {
  clientId: clientId
});

// Functions ++++++++++++++++++++++++++++++

function setup() {
  
  client.on('connect', () => client.subscribe('/memor/*') );
  client.on('message', (topic, message) => messageReceived(topic, message) );

  createCanvas( windowWidth, windowHeight );
  background( '#faad89' );

  fill('white');
  noStroke();
  textSize(48);

}

function draw() {  


}

function keyPressed() {

	// if (keyCode == BACKSPACE)
	
	
	text( 'message published! id = ' + id, 200, 400);
	client.publish( idaddr, JSON.stringify(memory) );

}

function moveCursor( x, y ) {



}

function messageReceived(topic, payload) {

	const topics = topic.split('/');

	console.log(JSON.parse(decoder.decode(payload)));

}

	</script>
</body>