<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="360" >
    <title>memor.io</title>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Symbols&display=swap');
    </style>
    
    <script src="https://unpkg.com/p5@1.4.0/lib/p5.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
    	body {
    		margin:  0;
    	}
    </style>
	</head>

	<body>
		<script>

const randomPos = () => [ Math.floor( Math.random() * width ), Math.floor( Math.random() * height ) ];
const setRandomPos = ( agent ) => { agent.x = randomPos()[0]; agent.y = randomPos()[1]; }
const randomB16Num = ( digits ) => Math.floor( Math.random() * Math.pow( 16, digits ) ).toString( 16 );  // generate random base-16 string with input number of digits i.e. 0-f
const randomUnicodeChar = () => { 
  let c, num;
  do { 
    num = parseInt( randomB16Num( 3 ), 16 );
    console.log( num );
    c = String.fromCodePoint( num );
  }
    while ( num < 32 || ( 65 < num && num < 880 ));
  return c;
  }

const decoder = new TextDecoder("utf-8");

const id = randomB16Num( 4 );  // generate random base-16 4-digit code as id i.e. 1-f
const char = randomUnicodeChar();
console.log( char );
const color = randomB16Num( 6 );

const thisAgent = {
  	id: id,
  	char: char,
  	color: color,
  	x: 200,
  	y: 200
  }




// const memory = [ thisAgent ];   // memory includes all agents that are attached.
const world  = [ thisAgent ];   // world includes all agents that are connected.

const agentSize = 40;

const clientId = "memorio-" + id;

const bg = "#fff";

let textX = 100;
let textY = 100;
const lineHeight = 30;
let font;

let v1, v2;
let speed = 2;

// MQTT --------------------
const server = "wss://datt3700:datt3700experiments@datt3700.cloud.shiftr.io";
const client = mqtt.connect(server, {
  clientId: clientId,
  will: {
    topic: '/memorio/disconnect',
    payload: JSON.stringify( thisAgent ),
    QoS: 1,
    retain: false
  }
});

// Functions ++++++++++++++++++++++++++++++

// function preload() {

//   font = loadFont('https://fonts.googleapis.com/css2?family=Noto+Sans+Symbols:wght@100&display=swap');
//   console.log(font);

// }

function setup() {

  createCanvas( windowWidth, windowHeight );

  background( bg );

  // setRandomPos( thisAgent );
  
  client.on('connect', () => client.subscribe('/memorio/*') );
  client.on('message', (topic, message) => messageReceived(topic, message) );
  client.publish( "memorio/connect", JSON.stringify( thisAgent ) );

  fill('white');
  noStroke();

  v1 = createVector();
  v2 = createVector();
  
  // let font = loawdFont( '../assets/noto.ttf' );
  // textFont( font );
  // textFont( '../assets/noto.ttf' );

}

function draw() { 

  background( 255 ,20);

  drawEdges();
  drawTitle();

  if ( mouseIsPressed ) move(); 
  
  textSize( agentSize );
  for ( a of world ) drawAgent( a );

}

function drawEdges() {
  fill( 235, 20 );
  rect( 0, 0, width / 3, height );
  rect( 0, 0, width, height / 3 );
  rect( width - ( width / 3 ), 0, width / 3, height );
  rect( 0, height - ( height / 3 ), width, height / 3 );
}

function drawTitle() {

  textSize( 24 );
  fill( 50 );
  textStyle( BOLD );
  text( 'Memor.io', 50, 50 );
  textStyle( NORMAL );
  fill( 100 );
  text( 'Press arrow keys/WASD', 50, 100 );
  text( 'or click on edges to move.', 50, 150 );

}

function drawAgent( agent ) {

  fill( "#" + agent.color );
  text( agent.char, agent.x, agent.y, agentSize )

}

let timer = 0;

function move() {

  v1.set( thisAgent.x, thisAgent.y );
  v2.set( mouseX, mouseY );

  v1.add( v2.sub( v1 ).setMag( speed ) );

  thisAgent.x = v1.x;
  thisAgent.y = v1.y;

  timer++;

  if ( timer % 5 == 0 )  client.publish( "/memorio/agent", JSON.stringify( thisAgent ) ); // limit

}

// const updateThisAgent = () => world[0] = thisAgent;

function keyPressed() {

  // thisAgent.char += 1;

  switch ( keyCode ) {

    case ( 37 ):
    case ( 65 ):
      thisAgent.x -= agentSize;
      break;

    case ( 38 ):
    case ( 87 ):
      thisAgent.y -= agentSize;
      break;
    
    case ( 39 ):
    case ( 68 ):
      thisAgent.x += agentSize;
      break;
    
    case ( 40 ):
    case ( 83 ):
      thisAgent.y += agentSize;
      break;

    case( 32 ):
      thisAgent.char = randomUnicodeChar();
      thisAgent.color = randomB16Num( 6 );

  }

  // updateThisAgent();

  client.publish( "/memorio/agent", JSON.stringify( thisAgent ) );

}

function mouseClicked() {

  let mouse = [ mouseX, mouseY ];

  console.log()

  if ( mouse[0] < width / 3 ) thisAgent.x -= agentSize;

  if ( mouse[1] < height / 3 ) thisAgent.y -= agentSize;

  if ( mouse[0] > width - ( width / 3 ) ) thisAgent.x += agentSize;

  if ( mouse[1] > height - ( height / 3 ) ) thisAgent.y += agentSize;


}

function messageReceived(topic, message) {

  topic = topic.split( '/' )[2];      // get the first sub branch of memorio.
  message = decoder.decode(message);  // decode array buffer.

  let agent = JSON.parse( message );    
  
  if ( agent.id == thisAgent.id ) return;  // if the received agent matches this agent, don't do anything.


  switch (topic) {

    case ( 'connect' ):
      world.push( agent );
      client.publish( '/memorio/world', JSON.stringify( thisAgent ) );
      console.log( 'new connection! world = ', world );
      break;

    case ( 'agent' ):
      let a = world.find( a => a.id == agent.id );
      if ( a ) {                // Tried other methods to make a deep copy (JSON.parse/stringify), but this works best.
        a.char = agent.char;
        a.color = agent.color;
        a.x = agent.x;
        a.y = agent.y;
      }
      console.log( "id: %s, char: %s, x: %i, y: %i", agent.id, agent.char, agent.x, agent.y );    // formats like printf
      break;

    case ( 'world' ):
      if ( !world.find( a => a.id == agent.id ) ) world.push( agent );
      console.log( 'received agent. new world = ', world );
      break;

    case ( 'disconnect' ):
      let index = world.findIndex( a => a.id == agent.id );
      if ( index > -1 ) world.splice( index, 1 );
      console.log( 'someone disconnected! new owrld = ', world);
      break;

    case ( 'chat' ):
      console.log( message );
      break;

  }

}

	</script>
</body>